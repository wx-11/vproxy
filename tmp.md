下面通过具体的示例，详细说明 `vproxy` 中 **用户名 ID** 和 **命令行参数 `-r`**（`CIDR-Range`）是如何协同工作来分配 IP 的，并着重解释每个 `Range` 下 ID 的运算关系。

---

### 示例背景

#### 基础配置
- 启动命令：
  ```bash
  vproxy run --bind 127.0.0.1:8101 -i 2001:db8::/32 --cidr-range 64 http -u test -p test
  ```
  - `-i 2001:db8::/32`：基础 CIDR 范围。
  - `--cidr-range 64`：指定子网范围为 `/64`。

#### 用户名格式
- 用户名扩展格式：`username-range-ID`
  - `username`：基本用户名。
  - `range`：表示这是一个 Range 扩展。
  - `ID`：特定范围内的唯一标识，用于计算分配的 IP。

---

### 每个 Range 的运算关系

#### 1. **基础规则**
- **命令行参数 `-r` 定义范围：**
  - `2001:db8::/32` 是基础网络，`--cidr-range 64` 将地址划分为多个 `/64` 的子网。
  - 每个子网的范围是：
    - `2001:db8::/64`
    - `2001:db8:0:1::/64`
    - `2001:db8:0:2::/64`
    - ...

- **用户名 ID 决定具体地址：**
  - 用户名中 `-range-ID` 的 `ID` 是一个输入值，经过哈希（`murmurhash3`）后生成固定数值 `(a, b)`。
  - `(a, b)` 被映射到指定子网中的主机部分，生成唯一 IP 地址。

---

#### 2. **计算示例**

##### 假设场景
基础网络是 `2001:db8::/32`，子网范围 `/64`。

##### 子网范围划分
1. 基于 `--cidr-range 64`，将基础网络划分为多个 `/64` 子网：
   - 第 1 个子网：`2001:db8::/64`
   - 第 2 个子网：`2001:db8:0:1::/64`
   - 第 3 个子网：`2001:db8:0:2::/64`
   - …

##### 用户名扩展 `username-range-123456`
1. 用户名 `username-range-123456` 中，`123456` 被输入哈希函数：
   - 通过 `murmurhash3_x64_128`，生成 128 位哈希值 `(a, b)`。
   - 例如：
     - `a = 0x1a2b3c4d5e6f7081`
     - `b = 0x9abcdef012345678`

2. 哈希值 `(a, b)` 结合子网：
   - `a` 和 `b` 经过合并，得到单一值 `combined`：
     ```rust
     combined = (a << 64) | b
     ```

3. 地址计算：
   - 网络部分由 `2001:db8::/64` 提供。
   - 主机部分通过 `combined % capacity` 生成（`capacity = 2^(128 - 64)`）。
   - 生成的完整 IP 地址可能是：`2001:db8::1a2b:3c4d:5e6f:7081`.

##### 用户名扩展 `username-range-987654`
1. ID `987654` 经过哈希计算，得到不同的哈希值 `(a', b')`。
   - 例如：
     - `a' = 0x2b3c4d5e6f708192`
     - `b' = 0xabcdef0123456789`

2. 生成的完整 IP 地址可能是：`2001:db8::2b3c:4d5e:6f70:8192`.

---

### 多个 Range 示例

假设 `--cidr-range` 为 96，意味着将基础 `/32` 网络划分为多个 `/96` 子网。

1. 基础子网划分：
   - 子网 1：`2001:db8::/96`，范围：
     - `2001:db8::0` 到 `2001:db8::ffff:ffff`.
   - 子网 2：`2001:db8::1:0/96`，范围：
     - `2001:db8::1:0` 到 `2001:db8::1:ffff:ffff`.
   - …

2. 用户名扩展示例：
   - 用户名 `username-range-123456` 的 ID 会计算一个固定值，并映射到某个 `/96` 子网的主机部分。
   - 生成的 IP 地址示例：
     - `2001:db8::0:1a2b:3c4d`.

   - 用户名 `username-range-987654` 会映射到另一个 `/96` 子网：
     - `2001:db8::1:2b3c:4d5e`.

---

### 总结

1. **命令行参数 `--cidr-range`**：
   - 决定子网的范围。例如：
     - `--cidr-range 64` 会生成多个 `/64` 子网。
     - `--cidr-range 96` 会生成多个 `/96` 子网。

2. **用户名中的 ID**：
   - 决定特定子网内的主机地址，生成固定的唯一 IP。

3. **运算关系公式**：
   - IP = 网络部分（基础 CIDR + 子网范围） + 主机部分（ID 哈希映射）。

通过这种方式，`vproxy` 实现了灵活且可控的 IP 地址分配。
